# نظام تحويل العملات المتقدم - CodeLIMS

## نظرة عامة

تم تطوير نظام متقدم لتحويل العملات في CodeLIMS يضمن دقة التقارير المالية ويدعم التعامل مع عملات متعددة بشكل احترافي.

---

## المميزات الرئيسية

### 1. **فصل تام بين الباك إند والفرونت إند**

#### الباك إند (Backend)

- **مسؤول عن:**
  - جميع عمليات تحويل العملات
  - حساب أسعار الصرف بين أي عملتين
  - استخراج التقارير المالية بعملة محددة أو عملات متعددة
  - تطبيق المنطق الحسابي والتحويلات
  - التحقق من صحة البيانات

- **الخدمات المتوفرة:**
  - `CurrencyConversionService`: خدمة متخصصة لتحويل العملات
  - `SaleService.getSalesReport()`: تقرير مبيعات مع دعم تحويل العملات

#### الفرونت إند (Frontend)

- **مسؤول عن:**
  - عرض البيانات المالية بشكل تفاعلي
  - تقديم واجهات لاختيار العملة المطلوبة
  - عرض تفاصيل التحويلات وأسعار الصرف
  - تصدير التقارير (Excel/PDF)

---

## 2. **نظام أسعار الصرف الديناميكي**

### آلية عمل أسعار الصرف

```javascript
// جميع أسعار الصرف محسوبة نسبة للعملة الأساسية (USD)
// مثال:
USD = 1.00 (عملة أساسية)
IQD = 1500 (دينار عراقي = 1500 لكل دولار)

// لتحويل من IQD إلى USD:
rate = 1 / 1500 = 0.000667

// لتحويل من USD إلى IQD:
rate = 1500 / 1 = 1500
```

### حفظ سعر الصرف التاريخي

- يتم حفظ سعر الصرف مع كل عملية بيع (`sales.exchangeRate`)
- يتم حفظ سعر الصرف مع كل دفعة (`payments.exchangeRate`)
- هذا يضمن دقة السجلات التاريخية حتى عند تغيير الأسعار

---

## 3. **التقارير المالية الذكية**

### عرض التقارير بعملة واحدة

عند اختيار عملة محددة (مثل USD):

1. يتم جمع جميع المبيعات من قاعدة البيانات
2. يتم تجميعها حسب عملتها الأصلية
3. يتم تحويل كل عملة إلى العملة المستهدفة باستخدام أسعار الصرف الحالية
4. يتم عرض الإجماليات المحولة

```javascript
// مثال:
المبيعات الأصلية:
- 1000 USD
- 1,500,000 IQD

التحويل إلى USD:
- 1000 USD = 1000 USD
- 1,500,000 IQD = 1000 USD (بسعر صرف 1500)

الإجمالي: 2000 USD
```

### عرض التقارير بعملات متعددة

عند اختيار "جميع العملات":

1. يتم عرض إجمالي منفصل لكل عملة
2. يتم عرض بطاقة تفصيلية لكل عملة
3. لا يتم تحويل القيم (تعرض بقيمتها الأصلية)
4. يظهر تنبيه للمستخدم بأن القيم غير محولة

---

## 4. **واجهات API المتوفرة**

### الحصول على تقرير المبيعات

```
GET /api/sales/report?startDate=2024-01-01&endDate=2024-12-31&currency=USD
```

**المعاملات:**

- `startDate`: تاريخ البداية (اختياري)
- `endDate`: تاريخ النهاية (اختياري)
- `currency`: العملة المطلوبة (USD/IQD أو null لجميع العملات)

**الاستجابة:**

```json
{
  "success": true,
  "data": {
    "totalSales": 5000.00,
    "totalPaid": 3000.00,
    "totalRemaining": 2000.00,
    "totalProfit": 1200.00,
    "avgSale": 250.00,
    "salesCount": 20,
    "currency": "USD",
    "currencySymbol": "$",
    "salesByCurrency": {
      "USD": { "totalSales": 3000, "count": 10, ... },
      "IQD": { "totalSales": 3000000, "count": 10, ... }
    }
  }
}
```

### الحصول على أسعار الصرف

```
GET /api/sales/currency/exchange-rates?baseCurrency=USD
```

**الاستجابة:**

```json
{
  "success": true,
  "data": {
    "USD": 1,
    "IQD": 1500
  }
}
```

### تحويل مبلغ بين عملتين

```
POST /api/sales/currency/convert
Content-Type: application/json

{
  "amount": 100,
  "fromCurrency": "USD",
  "toCurrency": "IQD"
}
```

**الاستجابة:**

```json
{
  "success": true,
  "data": {
    "originalAmount": 100,
    "fromCurrency": "USD",
    "toCurrency": "IQD",
    "convertedAmount": 150000,
    "exchangeRate": 1500
  }
}
```

---

## 5. **واجهة المستخدم**

### صفحة التقارير (`Reports.vue`)

**المميزات:**

- اختيار نطاق التاريخ
- اختيار العملة (USD/IQD/جميع العملات)
- عرض بطاقات إحصائية
- عرض تفصيلي لكل عملة عند اختيار "جميع العملات"
- تنبيه توضيحي حول حالة التحويل
- تصدير Excel مع تفاصيل كل عملة
- تصدير PDF مع جداول منفصلة

### صفحة أسعار الصرف (`ExchangeRates.vue`)

**المميزات:**

- عرض جميع العملات مع أسعار الصرف
- تعديل أسعار الصرف (ما عدا العملة الأساسية)
- محول عملات مباشر
- عرض آخر تحديث لكل عملة
- ملاحظات توضيحية حول آلية العمل

---

## 6. **الأمان والتحكم**

### التحقق والتفويض

- جميع endpoints محمية بـ JWT
- تطبيق RBAC على جميع العمليات
- صلاحية `sales:read` مطلوبة لعرض التقارير
- صلاحية `currencies:update` مطلوبة لتعديل أسعار الصرف

### تسجيل العمليات

- يتم تسجيل كل تعديل لسعر صرف في `activityLogs`
- يتم حفظ معلومات المستخدم والتاريخ

---

## 7. **دقة البيانات**

### ضمان الدقة

1. **تقريب موحد:** جميع القيم تُقرّب إلى رقمين عشريين
2. **حفظ تاريخي:** سعر الصرف محفوظ مع كل عملية
3. **فحص تلقائي:** التحقق من صحة العملات قبل التحويل
4. **عرض واضح:** رمز العملة يظهر مع كل قيمة

### أمثلة على الدقة

```javascript
// ✅ صحيح
totalSales: 1234.56
currency: "USD"
currencySymbol: "$"

// ✅ صحيح (عملات متعددة)
totalSales: 2734.56 (مجموع بدون تحويل)
currency: "MIXED"
salesByCurrency: {
  USD: { totalSales: 1234.56, count: 5 },
  IQD: { totalSales: 2250000, count: 3 }
}
```

---

## 8. **تجربة المستخدم**

### عرض واضح للعملات

- رمز العملة يظهر بشكل بارز
- ألوان مختلفة لكل عملة (اختياري)
- تنبيهات توضيحية عند الحاجة

### التصدير

- **Excel:** يشمل تفصيل كل عملة في أوراق منفصلة
- **PDF:** يعرض جداول منفصلة لكل عملة

### الملاحظات التوضيحية

- تظهر عند اختيار "جميع العملات" لتوضيح عدم التحويل
- تظهر عند اختيار عملة محددة لتوضيح التحويل

---

## 9. **أمثلة عملية**

### مثال 1: تقرير بعملة USD

```
المبيعات:
- بيع 1: 100 USD
- بيع 2: 150000 IQD (= 100 USD بسعر صرف 1500)

النتيجة:
totalSales: 200 USD
currency: USD
```

### مثال 2: تقرير بجميع العملات

```
المبيعات:
- بيع 1: 100 USD
- بيع 2: 150000 IQD

النتيجة:
totalSales: 150100 (مجموع بدون معنى)
currency: MIXED
salesByCurrency:
  - USD: { totalSales: 100, count: 1 }
  - IQD: { totalSales: 150000, count: 1 }
```

---

## 10. **التوسع المستقبلي**

### إمكانيات التطوير

1. **ربط API خارجي:** لتحديث أسعار الصرف تلقائياً
2. **تاريخ أسعار الصرف:** حفظ سجل تاريخي كامل
3. **عملات إضافية:** إضافة دعم لعملات أخرى (EUR, GBP, etc.)
4. **رسوم بيانية:** عرض تغيرات أسعار الصرف بمرور الوقت
5. **تنبيهات:** إشعارات عند تغير سعر الصرف بنسبة معينة

---

## الخلاصة

تم تطوير نظام متكامل لتحويل العملات يضمن:

- ✅ فصل تام بين الباك إند والفرونت إند
- ✅ دقة عالية في التقارير المالية
- ✅ دعم كامل للعملات المتعددة
- ✅ واجهات API واضحة وآمنة
- ✅ تجربة مستخدم ممتازة
- ✅ أمان وتحكم صارم
- ✅ قابلية التوسع المستقبلي

---

## المراجع

- **الباك إند:**
  - `packages/backend/src/services/currencyConversionService.js`
  - `packages/backend/src/services/saleService.js` (getSalesReport)
  - `packages/backend/src/controllers/saleController.js`
  - `packages/backend/src/routes/saleRoutes.js`

- **الفرونت إند:**
  - `packages/frontend/src/views/Reports.vue`
  - `packages/frontend/src/views/settings/ExchangeRates.vue`

- **قاعدة البيانات:**
  - `currencySettings` table: أسعار الصرف
  - `sales.exchangeRate`: سعر الصرف التاريخي للبيع
  - `payments.exchangeRate`: سعر الصرف التاريخي للدفعة
